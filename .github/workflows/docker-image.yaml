name: Build, Test, and Save Docker Image for Grand-Challenge

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_TAG: lunascore-open-development-phase

jobs:
  docker-train-test:
    runs-on: ubuntu-latest

    steps:     
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: 🔧 Convert Scripts to LF Endings
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          find . -type f -name "*.sh" -exec dos2unix {} \;

      - name: 🛠️ Make Scripts Executable
        run: chmod +x do_build.sh do_test_run.sh do_save.sh

      - name: 🐳 Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3        
        with:
          username: ${{ secrets.DOCKER_HUB_LUNASCORE }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: 🔨 Build Docker Image
        run: ./do_build.sh $DOCKER_IMAGE_TAG

    
      - name: Run inference test
        working-directory: ${{ github.workspace }}
        run: ./do_test_run.sh $DOCKER_IMAGE_TAG

      #- name: 🧪 Run Test Script
      #  run: ./do_test_run.sh $DOCKER_IMAGE_TAG
      - name: Cleanup Docker before saving image
        run: |
          docker system prune -af --volumes
          docker builder prune -af

            

      - name: 📦 Save Docker Image to Archive
        run: ./do_save.sh $DOCKER_IMAGE_TAG

      # OPTIONAL: Push image to Docker Hub
      - name: Build Docker image
        run: docker build -t kibromberihu/lunascore-open-development-phase:latest .
      - name: Push Docker image
        run: docker push kibromberihu/lunascore-open-development-phase:latest