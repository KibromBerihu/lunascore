name: Build, Test, and Save Docker Image for Grand-Challenge

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_TAG: lunascore-open-development-phase

jobs:
  docker-train-test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Convert Scripts to LF Endings
        run: |
          sudo apt-get update && sudo apt-get install -y dos2unix
          find . -type f -name "*.sh" -exec dos2unix {} \;

      - name: 🛠️ Make Scripts Executable
        run: chmod +x do_build.sh do_test_run.sh do_save.sh

      - name: 🐳 Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: 🔨 Build Docker Image
        run: ./do_build.sh $DOCKER_IMAGE_TAG

      - name: 🧪 Run Test Script
        run: ./do_test_run.sh $DOCKER_IMAGE_TAG

      - name: 📦 Save Docker Image to Archive
        run: ./do_save.sh $DOCKER_IMAGE_TAG

      # OPTIONAL: Push image to Docker Hub
      # - name: 🚀 Push to Docker Hub
      #   run: docker push $DOCKER_IMAGE_TAG
